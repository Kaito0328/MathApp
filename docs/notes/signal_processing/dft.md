# 離散フーリエ変換（DFT）と畳み込み

## 背景知識
DFT は有限長信号を複素指数の基底に展開する変換である。畳み込み定理により，時系列の畳み込みは周波数領域での点ごと積に対応する。

## 入力例と出力例
- 入力: 時系列 `Signal` または複素列。
- 出力: `Spectrum` または複素列。

## アルゴリズム
- dft_simple/ift_simple（定義式）
	- 式: X[k] = Σ_{n=0}^{N-1} x[n]·e^{-j2πkn/N}。O(N^2) である。
	- 小規模 N の検証・参照用である。

- FFT（Cooley–Tukey）
	- 入力長 N を素因数分解し（2^a·3^b·5^c…），可能なら基数2反復 in-place を用いる。
	- 基数2反復の流れ:
		1) ビット反転並べ替え（入力を再配置）。
		2) 段 m = 1..log2 N でバタフライ: 長さ L=2^m のブロックごとに，回転因子 W_N^{k} を用いて偶奇を合成。
		3) 逆変換は回転因子の符号を反転し，最後に 1/N で正規化する（規約に依存）。
	- 混合基数: N が 2 の冪でない場合は 2/3/5 を優先して分割し，ストライド付き FFT を合成する。
	- 任意長対応: Bluestein（Chirp-Z）で DFT を畳み込みに帰着し FFT で解く。線形畳み込みにするためゼロパディング長を 2 の冪へ拡張する。
	- 実数入力最適化: 共役対称性 X[N−k]=conj(X[k]) を利用し半分のスペクトルのみ保持する。

- 直列畳み込みと周波数領域畳み込み
	- 直接法 conv_simple: y[n] = Σ h[k]·x[n−k]。短いタップで有利。O(NM)。
	- FFT 法 conv_fft: 長さ L を選び，h とブロックをゼロパディングし FFT→点ごと積→IFFT。線形畳み込みにするには Overlap-Add か Overlap-Save を用いる。
		- Overlap-Add: 入力を長さ L のブロックに分割し，各ブロック出力を M−1 サンプル重ね合わせる（M はフィルタ長）。
		- Overlap-Save: 各ブロックの先頭 M−1 サンプルを捨てて連結する。ストリーミングに適する。

- スペクトル正規化と取り決め
	- 正規化: 逆変換のみ 1/N，あるいは正逆で 1/√N を採る。内部表現と API を一貫させる。
	- 周波数軸: 0..N−1 を 0..Fs へ線形対応，実数 FFT では DC と Nyquist を実数として特別扱いする。

### 境界条件・安定化
- 回転因子の計算は sincos の同時計算や事前テーブルで誤差と計算量を抑える。
- 畳み込みの線形/循環の取り違いを避けるため，ゼロパディング長を N+M−1 以上にする。
- きわめて大きい N では丸め誤差が蓄積するため，段ごとにスケーリングを均一化する（逆変換時にまとめて 1/N を掛けるなど）。

### 計算量
- 直計算: O(N^2)。FFT: O(N log N)。Overlap-Add/Save の 1 ブロック当たりは O(L log L)。
